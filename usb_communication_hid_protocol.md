## USB枚举成HID协议设备 

* 什么选择HID进行通信？

**优势**：我们不需要针对pc下进行usb驱动开发，系统是免驱的，即系统自带HID驱动程序。真正实现设备即插即用。

**劣势**：当我们设备选择了HID进行通信，也就意味着速度是个大问题。如果对设备通信速度要求不是特别高的话，hid协议通信是个不错选择。

* 数据传输方式

设备是被动设备，需要PC进行一次“写读”来完成一次数据交互，数据发起方只能是PC。

### HID报告描述符
设置输入和输出报告长度为136字节。这样我们每次在pc上对设备进行读写时候发送和接收均已136字节为一包数据进行交互。这个长度可以根据我们实际需要进行修改。

设备HID报告描述符如下：
```c
const unsigned char hid_report_desc[] =
{
    0x06, 0xA0, 0xFF,   // usage page (vendor spec)
    0x09, 0x01,         // usage (vendor spec)
    0xA1, 0x01,         // collection (application)
    0x09, 0x02,         // usage (vendor spec)
    0xA1, 0x00,         // collection (linked)
    0x06, 0xA1, 0xFF,   // usage page (vendor defined)
    0x09, 0x03,         // usage (vendor spec)
    0x09, 0x04,         // usage (vendor defined)
    0x15, 0x80,         // logic min(-127)
    0x25, 0x7f,         // logic max(128)
    0x75, 0x08,         // report size(8 bit each)
    0x95, 0x88,         // report count(136 reports)
    0x81, 0x02,         // input(data, variable, absolute)
    0x09, 0x05,         // usage (vendor spec)
    0x09, 0x06,         // usage (vendor defined)
    0x15, 0x80,         // logic min(-127)
    0x25, 0x7f,         // logic max(128)
    0x75, 0x08,         // report size(8 bit each)
    0x95, 0x88,         // report count(136 reports)
    0x91, 0x02,         // output(data, variable, absolute)
    0xc0,               // end collection
    0xc0                // end collection
};
```

```
0x75, 0x08,          // report size(8 bit each) 报表数据域所包含位数8bit
0x95, 0x88,          // report count(64 reports) 报表中数据域的数目0x88个
```
由此可以看出数据输出和输入均为136x8位，即一次传输136字节数据。报告描述符里"report count"报告数量可以根据我们时间开发进行选择。报告符格式，请自行查看HID1.1协议。



### HID定长数据传输
定长数据传输：PC与设备进行数据交互时候，按报告描述符约定好的136字节进行数据交互。每次数据交互均是pc发起数据指令，设备接收后处理应答，收发包大小为136字节。

Bus Hound数据包：
```
//指令1
     CTL    21 09 00 02  00 00 88 00                            SET REPORT         37ms        19.1.0
136  OUT    80 ca 07 00  00 00 00 03  00 00 00 00  00 00 00 00  ................  579us        19.2.0
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               19.2.16
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               19.2.32
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               19.2.48
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               19.2.64
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               19.2.80
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               19.2.96
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               19.2.112
            00 00 00 00  00 00 00 00                            ........                       19.2.128
136  IN     90 00 08 00  00 00 00 03  00 00 00 00  00 00 00 00  ................  2.5ms        20.1.0
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               20.1.16
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               20.1.32
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               20.1.48
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               20.1.64
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               20.1.80
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               20.1.96
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               20.1.112
            00 00 00 00  00 00 00 00                            ........                       20.1.128

//指令2
    CTL    21 09 00 02  00 00 88 00                            SET REPORT         26ms        21.1.0
136  OUT    80 ca 01 00  00 00 00 74  00 00 00 00  00 00 00 00  .......t........  495us        21.2.0 
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               21.2.16
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               21.2.32
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               21.2.48
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               21.2.64
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               21.2.80
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               21.2.96
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               21.2.112
            00 00 00 00  00 00 00 00                            ........                       21.2.128
136  IN     90 00 01 01  4f 6e 65 4b  65 79 00 00  00 00 00 00  ....OneKey......  3.0ms        22.1.0
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               22.1.16
            00 00 00 00  4f 6e 65 4b  65 79 00 00  00 00 00 00  ....OneKey......               22.1.32
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               22.1.48
            00 00 00 00  31 37 30 35  30 32 30 30  39 34 00 ff  ....1705020094..               22.1.64
            ff ff ff ff  ff ff ff ff  ff ff ff ff  ff ff ff ff  ................               22.1.80
            ff ff ff ff  01 00 01 00  ff ff fc 00  00 00 e0 00  ................               22.1.96
            00 00 f0 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               22.1.112
            00 00 00 00  00 00 00 00                            ........                       22.1.128


```

### HID变长传输数据传输
变长传输数据传输：pc与设备进行大数据交互时候，pc按每包136字节进行分包，多次发送到设备，设备多次中断接收后内部拼接数据，然后进行处理，处理后再多次分包发出。这样可以减少每次包应答导致的速度慢问题。传输速度可以提高很多。经测试30KB数据写入(写入芯片FLASH，包括扇区擦除时间)大概需要1s多点。

**优点**:当我们设备按照变成数据方式传输，传输小于136字节可以一包完成传输，传输大于136字节数据时候，使用变长传输方式，这样可以实现最大化传输速率。

**缺点**:相比定长数据传输协议实现起来比较复杂。

Bus Hound数据包：
```
//输出数据0x3a2大小
     CTL    21 09 00 02  00 00 88 00                            SET REPORT        103ms        11.1.0
136  OUT    00 11 00 00  03 a2 00 00  00 00 00 00  00 00 00 00  ................  528us        11.2.0
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               11.2.16
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               11.2.32
            00 00 00 00  00 74 65 73  74 30 00 00  00 00 00 00  .....test0......               11.2.48
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               11.2.64
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               11.2.80
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               11.2.96
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               11.2.112
            00 00 00 00  00 00 00 00                            ........                       11.2.128
     CTL    21 09 00 02  00 00 88 00                            SET REPORT         14ms        12.1.0
136  OUT    00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................  501us        12.2.0
            ...
            ...
     CTL    21 09 00 02  00 00 88 00                            SET REPORT         14ms        12.1.0
136  OUT    00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................  501us        12.2.0
            ...
            ...
     CTL    21 09 00 02  00 00 88 00                            SET REPORT         14ms        12.1.0    
136  OUT    00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................  501us        12.2.0
            ...
            ...
            
136  IN     90 00 00 00  03 a2 00 00  00 00 00 00  00 00 00 00  ................   88ms        18.1.0
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               18.1.16
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               18.1.32
            00 00 00 00  00 74 65 73  74 30 00 00  00 00 00 00  .....test0......               18.1.48
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               18.1.64
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               18.1.80
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               18.1.96
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................               18.1.112
            00 00 00 00  00 00 00 00                            ........                       18.1.128

//输入数据0x3a2大小
     CTL    21 09 00 02  00 00 88 00                            SET REPORT         25ms         3.1.0
136  OUT    00 10 00 00  00 00 03 a2  00 00 00 00  00 00 00 00  ................  485us         3.2.0
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................                3.2.16
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................                3.2.32    
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................                3.2.48
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................                3.2.64
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................                3.2.80
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................                3.2.96
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................                3.2.112
            00 00 00 00  00 00 00 00                            ........                        3.2.128
136  IN     90 00 01 00  00 00 00 00  00 00 00 00  00 00 00 00  ................  3.3ms         4.1.0    
            00 01 01 01  01 01 01 01  01 01 01 01  01 01 01 01  ................                4.1.16
            05 00 00 00  00 00 00 00  00 00 00 00  00 00 00 74  ...............t                4.1.32
            65 73 74 30  00 00 00 00  00 00 00 00  00 00 00 00  est0............                4.1.48
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................                4.1.64
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................                4.1.80
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................                4.1.96
            00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................                4.1.112
            00 00 00 00  00 00 00 00                            ........                        4.1.128
136  IN     00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................  2.9ms         5.1.0(2)
            ...
            ...
136  IN     00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................  2.9ms         5.1.0
            ...
            ...
136  IN     00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................  2.9ms         5.1.0
            ...            
            ...   
```

## USB枚举成CCID协议设备

## USB枚举成Umass协议设备
